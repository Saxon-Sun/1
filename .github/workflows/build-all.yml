name: Build immortalwrt Firmware

on:
  workflow_dispatch:
    inputs:
      build_x86_1:
        description: '编译x86 - 93'
        required: false
        type: boolean
        default: true
      build_x86_2:
        description: '编译 x86 - 1102' 
        required: false
        type: boolean
        default: false
      build_x86_3:
        description: '编译 x86 - br' 
        required: false
        type: boolean
        default: false
      build_n1:
        description: '编译 N1 固件'
        required: true
        type: boolean
        default: false
      ssh:
        description: '开启 SSH 连接 (调试用)'
        required: false
        type: boolean
        default: false

jobs:
  init_x86:
    runs-on: ubuntu-latest
    outputs:
      targets: ${{ steps.set-targets.outputs.targets }}
      has_target: ${{ steps.set-targets.outputs.has_target }}
    steps:
      - id: set-targets
        run: |
          JSON_LIST="["
          HAS_TARGET="false"
          
          if [ "${{ inputs.build_x86_1 }}" == "true" ]; then
            JSON_LIST="$JSON_LIST \"immortalwrt-x86-93\","
            HAS_TARGET="true"
          fi
          
          if [ "${{ inputs.build_x86_2 }}" == "true" ]; then
            JSON_LIST="$JSON_LIST \"immortalwrt-x86-1102\"," 
            HAS_TARGET="true"
          fi
          if [ "${{ inputs.build_x86_3 }}" == "true" ]; then
            JSON_LIST="$JSON_LIST \"br-x86\"," 
            HAS_TARGET="true"
          fi
          
          if [[ "$JSON_LIST" == *"," ]]; then
            JSON_LIST="${JSON_LIST%?}"
          fi
          JSON_LIST="$JSON_LIST]"
          
          echo "targets=$JSON_LIST" >> $GITHUB_OUTPUT
          echo "has_target=$HAS_TARGET" >> $GITHUB_OUTPUT
          echo "生成的编译列表: $JSON_LIST"

  # =======================================================
  # 任务 1: x86 固件
  # =======================================================
  build_x86:
    name: Build x86 - ${{ matrix.target }}
    needs: init_x86
    if: needs.init_x86.outputs.has_target == 'true'
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJson(needs.init_x86.outputs.targets) }}

    env:
      TARGET_Name: ${{ matrix.target }}
      REPO_URL: https://github.com/immortalwrt/immortalwrt
      REPO_BRANCH: openwrt-24.10
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v5
    
    - name: Maximize Build Space
      uses: coder-xiaomo/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: 创建模拟物理磁盘
      run: |
        mnt_size=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 1)
        root_size=$(expr $(df -h / | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 4)
        sudo truncate -s "${mnt_size}"G /mnt/mnt.img
        sudo truncate -s "${root_size}"G /root.img
        sudo losetup /dev/loop6 /mnt/mnt.img
        sudo losetup /dev/loop7 /root.img
        sudo pvcreate /dev/loop6
        sudo pvcreate /dev/loop7
        sudo vgcreate github /dev/loop6 /dev/loop7
        sudo lvcreate -n runner -l 100%FREE github
        sudo mkfs.xfs /dev/github/runner
        sudo mkdir -p /github-builder
        sudo mount /dev/github/runner /github-builder
        sudo chown -R $USER:$GROUPS /github-builder
        df -Th

    - name: Initialize Build Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
        sudo timedatectl set-timezone Asia/Shanghai
        df -h

    - name: Clone Source Code
      working-directory: /github-builder
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /github-builder/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        git clone --depth 1 https://Saxon-Sun:${{ secrets.pw }}@github.com/Saxon-Sun/Route-config-Files.git
        df -hT $PWD

    - name: Configure Feeds
      run: |
        cd openwrt
        cp -r Route-config-Files/$TARGET_Name/* .
        chmod +x Route-config-Files/diy/*.sh
        mv Route-config-Files/diy/*.sh .
        ./Add-Source.sh
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply Custom Configuration
      run: |
        cd openwrt
        cp -rf Route-config-Files/public/* files/
        ./diy.sh x86
        make defconfig

    - name: Enable SSH (Optional)
      if: github.event.inputs.ssh == 'true'
      uses: Saxon-Sun/ssh2actions@main
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: Download Dependencies
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt
        if ! make -j$(nproc); then
            df -h
            echo "❌ 编译失败，正在分析磁盘使用情况..."
            make -j1 V=s
        fi
        echo "✅ 编译成功!"
        df -h
        rm -rf $(find ./bin/targets/ -type d -name "packages")
        rm -rf $(find ./bin/targets/ -type f -name "*rootfs*")
        rm -rf build_dir
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Prepare Artifacts
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt
        mkdir -p artifact/{firmware,package}
        find bin/targets/ -type f -exec cp -f {} artifact/firmware/ \;
        find bin/packages/ -type f -name "*.ipk" -exec cp -f {} artifact/package/ \;

    - name: Upload Firmware
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt
        ./upload.sh $TARGET_Name

  # =======================================================
  # 任务 2: N1 固件
  # =======================================================
  build_n1:
    name: Build N1 Firmware
    if: github.event.inputs.build_n1 == 'true'
    runs-on: ubuntu-latest
    env:
      TARGET_Name: immortalwrt-N1
      REPO_URL: https://github.com/immortalwrt/immortalwrt
      REPO_BRANCH: openwrt-24.10

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v5
    
    - name: Maximize Build Space
      uses: coder-xiaomo/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: 创建模拟物理磁盘
      run: |
        mnt_size=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 1)
        root_size=$(expr $(df -h / | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 4)
        sudo truncate -s "${mnt_size}"G /mnt/mnt.img
        sudo truncate -s "${root_size}"G /root.img
        sudo losetup /dev/loop6 /mnt/mnt.img
        sudo losetup /dev/loop7 /root.img
        sudo pvcreate /dev/loop6
        sudo pvcreate /dev/loop7
        sudo vgcreate github /dev/loop6 /dev/loop7
        sudo lvcreate -n runner -l 100%FREE github
        sudo mkfs.xfs /dev/github/runner
        sudo mkdir -p /github-builder
        sudo mount /dev/github/runner /github-builder
        sudo chown -R $USER:$GROUPS /github-builder
        df -Th

    - name: Initialize Build Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
        sudo timedatectl set-timezone Asia/Shanghai
        df -h

    - name: Clone Source Code
      working-directory: /github-builder
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /github-builder/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        git clone --depth 1 https://Saxon-Sun:${{ secrets.pw }}@github.com/Saxon-Sun/Route-config-Files.git
        df -hT $PWD

    - name: Configure Feeds
      run: |
        cd openwrt
        rm -rf package/luci-app-amlogic
        git clone --depth 1 https://github.com/ophub/luci-app-amlogic.git package/luci-app-amlogic
        cp -r Route-config-Files/$TARGET_Name/* .
        chmod +x Route-config-Files/diy/*.sh
        mv Route-config-Files/diy/*.sh .
        ./Add-Source.sh
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply Custom Configuration
      run: |
        cd openwrt
        cp -rf Route-config-Files/public/* files/
        ./diy.sh n1
        make defconfig

    - name: Enable SSH (Optional)
      if: github.event.inputs.ssh == 'true'
      uses: Saxon-Sun/ssh2actions@main
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: Download Dependencies
      id: package
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s
        echo "======================="
        echo "Space usage:"
        df -h
        echo "======================="
        rm -rf build_dir
        rm -rf $(find ./bin/targets/ -type d -name "packages")
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Package Armvirt as OpenWrt
      if: steps.compile.outputs.status == 'success' && !cancelled()
      uses: unifreq/openwrt_packit@master
      env:
        OPENWRT_ARMVIRT: openwrt/bin/targets/*/*/*.tar.gz
        PACKAGE_SOC: s905d
        WHOAMI: Saxon

    - name: Prepare Artifacts
      if: env.PACKAGED_STATUS == 'success' && !cancelled()
      run: |
        cd openwrt
        mkdir -p artifact/firmware
        mkdir -p artifact/package
        ls -lh /opt/openwrt_packit/output
        find /opt/openwrt_packit/output -type f -exec cp -f {} artifact/firmware/ \;
        find artifact/firmware/ -type f -not -name "*+o*" -exec rm -f {} \;
        ./upload.sh $TARGET_Name

  # =======================================================
  # 任务 3: 清理
  # =======================================================
  cleanup:
    runs-on: ubuntu-latest
    needs: [build_x86, build_n1]
    if: always()
    steps:
    - name: Cleanup Workflow Runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        token: ${{ secrets.pw }}
        repository: ${{ github.repository }}
        retain_days: 1
        keep_minimum_runs: 2