name: Build immortalwrt Firmware

on:
  workflow_dispatch:
    inputs:
      build_x86_1:
        description: 'ç¼–è¯‘ x86 - 93'
        required: false
        type: boolean
        default: true
      build_x86_2:
        description: 'ç¼–è¯‘ x86 - 1102'
        required: false
        type: boolean
        default: false
      build_x86_3:
        description: 'ç¼–è¯‘ x86 - br'
        required: false
        type: boolean
        default: false
      build_n1:
        description: 'ç¼–è¯‘ N1 å›ºä»¶'
        required: false
        type: boolean
        default: false
      ssh:
        description: 'å¼€å¯ SSH è¿æ¥ (è°ƒè¯•ç”¨)'
        required: false
        type: boolean
        default: false

jobs:
  # =======================================================
  # åˆå§‹åŒ–çŸ©é˜µ
  # =======================================================
  init:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_target: ${{ steps.set-matrix.outputs.has_target }}
    steps:
      - id: set-matrix
        run: |
          TARGETS=()
          [[ "${{ inputs.build_x86_1 }}" == "true" ]] && TARGETS+=('{"target": "immortalwrt-x86-93"}')
          [[ "${{ inputs.build_x86_2 }}" == "true" ]] && TARGETS+=('{"target": "immortalwrt-x86-1102"}')
          [[ "${{ inputs.build_x86_3 }}" == "true" ]] && TARGETS+=('{"target": "br-x86"}')
          [[ "${{ inputs.build_n1 }}" == "true" ]] && TARGETS+=('{"target": "immortalwrt-N1"}')
          
          if [ ${#TARGETS[@]} -eq 0 ]; then
             echo "has_target=false" >> $GITHUB_OUTPUT
             echo "âš ï¸ æœªé€‰æ‹©ä»»ä½•ç¼–è¯‘ç›®æ ‡"
          else
             JSON_STRING=$(IFS=,; echo "${TARGETS[*]}")
             echo "matrix={\"include\": [$JSON_STRING]}" >> $GITHUB_OUTPUT
             echo "has_target=true" >> $GITHUB_OUTPUT
             echo "âœ… ç”Ÿæˆçš„ç¼–è¯‘çŸ©é˜µ: [$JSON_STRING]"
          fi

  # =======================================================
  # ç»Ÿä¸€ç¼–è¯‘ä»»åŠ¡ (å¹¶è¡Œ + ç¼“å­˜åŠ é€Ÿ)
  # =======================================================
  build:
    name: Build - ${{ matrix.target }}
    needs: init
    if: needs.init.outputs.has_target == 'true'
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: write
    
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.init.outputs.matrix) }}
    env:
      TARGET_Name: ${{ matrix.target }}
      REPO_URL: https://github.com/immortalwrt/immortalwrt
      REPO_BRANCH: openwrt-24.10
      TZ: Asia/Shanghai

    steps:
    - name: Checkout Private Config Repo
      uses: actions/checkout@v5
      with:
        repository: Saxon-Sun/Route-config-Files
        token: ${{ secrets.pw }}
        path: Route-config-Files
        fetch-depth: 1

    # =======================================================
    # æ ¸å¿ƒæ­¥éª¤ï¼šè‡ªåŠ¨è¯†åˆ«æ¶æ„
    # =======================================================
    - name: Determine Architecture
      id: arch
      run: |
        echo "æ­£åœ¨æ£€æŸ¥ç›®æ ‡åç§°: $TARGET_Name"
        TARGET_LOWER="${TARGET_Name,,}"
        
        if [[ "$TARGET_LOWER" == *"n1"* ]]; then
            echo "BUILD_TYPE=n1" >> $GITHUB_ENV
            echo "âœ… è¯†åˆ«ä¸º N1 æ¶æ„"
        elif [[ "$TARGET_LOWER" == *"x86"* ]]; then
            echo "BUILD_TYPE=x86" >> $GITHUB_ENV
            echo "âœ… è¯†åˆ«ä¸º x86 æ¶æ„"
        else
            echo "âŒ è‡´å‘½é”™è¯¯ï¼šæ— æ³•ä» '$TARGET_Name' ä¸­è¯†åˆ«æ¶æ„ï¼"
            echo "è¯·ç¡®ä¿ Target åç§°åŒ…å« 'x86' æˆ– 'n1'ã€‚"
            exit 1
        fi

    - name: Maximize Build Space
      uses: coder-xiaomo/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: åˆ›å»ºæ¨¡æ‹Ÿç‰©ç†ç£ç›˜ (LVM)
      run: |
        mnt_size=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 1)
        root_size=$(expr $(df -h / | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 4)
        sudo truncate -s "${mnt_size}"G /mnt/mnt.img
        sudo truncate -s "${root_size}"G /root.img
        sudo losetup /dev/loop6 /mnt/mnt.img
        sudo losetup /dev/loop7 /root.img
        sudo pvcreate /dev/loop6
        sudo pvcreate /dev/loop7
        sudo vgcreate github /dev/loop6 /dev/loop7
        sudo lvcreate -n runner -l 100%FREE github
        sudo mkfs.xfs /dev/github/runner
        sudo mkdir -p /github-builder
        sudo mount /dev/github/runner /github-builder
        sudo chown -R $USER:$GROUPS /github-builder
        df -Th

    - name: Initialize Build Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
        sudo timedatectl set-timezone $TZ
        sudo apt-get update && sudo apt-get install -y ccache

    - name: Clone Source Code
      working-directory: /github-builder
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /github-builder/openwrt $GITHUB_WORKSPACE/openwrt

    # =======================================================
    # ç¼“å­˜æœºåˆ¶ : ä½¿ç”¨ env.BUILD_TYPE ä½œä¸º Key
    # =======================================================
    - name: Restore Ccache
      uses: actions/cache/restore@v4
      with:
        path: /github-builder/openwrt/.ccache
        key: ${{ runner.os }}-ccache-${{ env.BUILD_TYPE }}-${{ env.REPO_BRANCH }}-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-ccache-${{ env.BUILD_TYPE }}-${{ env.REPO_BRANCH }}-
          ${{ runner.os }}-ccache-${{ env.BUILD_TYPE }}-

    - name: Configure Feeds & Apply Mods
      working-directory: /github-builder/openwrt
      run: |
        echo "æ­£åœ¨å¯¼å…¥ç§æœ‰é…ç½®..."
        cp -r $GITHUB_WORKSPACE/Route-config-Files .
        ls -R Route-config-Files | head -n 5
        
        # [N1 ç‰¹æœ‰æ­¥éª¤] æ›¿æ¢ amlogic æ’ä»¶
        if [ "$BUILD_TYPE" == "n1" ]; then
          echo "æ£€æµ‹åˆ° N1 æ„å»ºï¼Œå¤„ç† amlogic æ’ä»¶..."
          rm -rf package/luci-app-amlogic
          git clone --depth 1 https://github.com/ophub/luci-app-amlogic.git package/luci-app-amlogic
        fi
        
        chmod +x Route-config-Files/diy/*.sh
        mv Route-config-Files/diy/*.sh .
        ./Add-Source.sh
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply Custom Configuration
      working-directory: /github-builder/openwrt
      run: |
        ./diy.sh $BUILD_TYPE
        make defconfig

    - name: Enable SSH (Optional)
      if: inputs.ssh == true
      uses: Saxon-Sun/ssh2actions@main
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: Download Dependencies
      working-directory: /github-builder/openwrt
      run: |
        make download -j$(nproc)
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile Firmware
      working-directory: /github-builder/openwrt
      id: compile
      run: |
        export CCACHE_DIR=$(pwd)/.ccache
        mkdir -p "$CCACHE_DIR"
        
        ccache -M 2G -F 0
        echo "====== Ccache åˆå§‹çŠ¶æ€ ======"
        ccache -s
        echo "============================="
        
        echo "å¼€å§‹ç¼–è¯‘..."
        if ! make -j$(nproc); then
            echo "âŒ å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œæ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ..."
            df -h
            echo "å°è¯•å•çº¿ç¨‹å¹¶è¾“å‡ºæ—¥å¿—..."
            make -j1 V=s
        fi
        echo "âœ… ç¼–è¯‘æµç¨‹ç»“æŸ"
        
        echo "====== ç¼–è¯‘å Ccache ç»Ÿè®¡ ======"
        ccache -s
        echo "================================"
        
        echo "æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ..."
        df -h
        rm -rf build_dir
        rm -rf $(find ./bin/targets/ -type d -name "packages")
        find ./bin/targets/ -type f -name "*squashfs-rootfs*" -exec echo "ğŸ—‘ï¸  åˆ é™¤æ–‡ä»¶: {}" \; -delete
        ls -la "$GITHUB_WORKSPACE"/openwrt/bin/targets/*/*/*
        
        if [ -n "$(find bin/targets/ -name '*.tar.gz' -o -name '*.img*')" ]; then
             echo "status=success" >> $GITHUB_OUTPUT
        else
             echo "âš ï¸ æœªæ£€æµ‹åˆ°å›ºä»¶äº§ç‰©ï¼Œå¯èƒ½ç¼–è¯‘å¤±è´¥"
        fi

    # ==========================================
    # N1 ç‰¹æœ‰æ­¥éª¤: æ‰“åŒ… Armvirt ä¸º OpenWrt
    # ==========================================
    - name: Package Armvirt as OpenWrt (N1 Only)
      if: steps.compile.outputs.status == 'success' && env.BUILD_TYPE == 'n1' && !cancelled()
      uses: unifreq/openwrt_packit@master
      env:
        OPENWRT_ARMVIRT: openwrt/bin/targets/*/*/*.tar.gz
        PACKAGE_SOC: s905d
        WHOAMI: Saxon

    # ==========================================
    # å¤„ç† Artifacts å’Œä¸Šä¼ 
    # ==========================================
    - name: Prepare Artifacts
      working-directory: /github-builder/openwrt
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        mkdir -p artifact/{firmware,package}
        
        if [ "$BUILD_TYPE" == "n1" ]; then
          # N1 å¤„ç†é€»è¾‘
          ls -lh /opt/openwrt_packit/output
          find /opt/openwrt_packit/output -type f -exec cp -f {} artifact/firmware/ \;
          find artifact/firmware/ -type f -not -name "*+o*" -exec rm -f {} \;
        else
          # x86 å¤„ç†é€»è¾‘
          find bin/targets/ -type f -exec cp -f {} artifact/firmware/ \;
          find bin/packages/ -type f -name "*.ipk" -exec cp -f {} artifact/package/ \;
        fi

    - name: Upload Firmware via Script
      working-directory: /github-builder/openwrt
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        ./upload.sh $TARGET_Name
        
    - name: Delete Old Caches
      if: steps.compile.outputs.status == 'success' && !cancelled() && (env.BUILD_TYPE == 'n1' || matrix.target == 'immortalwrt-x86-93')
      uses: actions/github-script@v7
      with:
        script: |
          const buildType = process.env.BUILD_TYPE;
          const repoBranch = process.env.REPO_BRANCH;
          
          console.log(`ğŸ” [ç®¡ç†å‘˜æ¨¡å¼] æ­£åœ¨æ¸…ç† ${buildType} æ¶æ„æ—§ç¼“å­˜...`);
          const key_prefix = `${{ runner.os }}-ccache-${buildType}-${repoBranch}-`;
          try {
            const caches = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
              key: key_prefix,
              ref: context.ref,
            });
            for (const cache of caches.data.actions_caches) {
              console.log(`ğŸ—‘ï¸  åˆ é™¤æ—§ç¼“å­˜ ID: ${cache.id} Key: ${cache.key}`);
              await github.rest.actions.deleteActionsCacheById({
                owner: context.repo.owner,
                repo: context.repo.repo,
                cache_id: cache.id,
              });
            }
          } catch (error) {
            console.log(`âš ï¸  æ¸…ç†å¤±è´¥: ${error.message}`);
          }

    - name: Save Ccache
      if: steps.compile.outputs.status == 'success' && !cancelled() && (env.BUILD_TYPE == 'n1' || matrix.target == 'immortalwrt-x86-93')
      uses: actions/cache/save@v4
      with:
        path: /github-builder/openwrt/.ccache
        key: ${{ runner.os }}-ccache-${{ env.BUILD_TYPE }}-${{ env.REPO_BRANCH }}-${{ github.run_id }}
        
  # =======================================================
  # æ¸…ç†å†å²è®°å½•
  # =======================================================
  cleanup:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
    - name: Cleanup Workflow Runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        token: ${{ secrets.pw }}
        repository: ${{ github.repository }}
        retain_days: 1
        keep_minimum_runs: 2